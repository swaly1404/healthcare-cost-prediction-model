---
title: "Mini Project 2 - Healthcare Costs Prediction"
author: "Salih Awel"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(caret)
```

# Introduction

 In order to have  efficient healthcare management accurate healthcare cost prediction models are vital. These models help insurers and healthcare providers target care management resources to high-risk individuals, improving financial planning and resource allocation. For patients, accurate predictions enable informed selection of insurance plans with appropriate deductibles based on anticipated needs. Healthcare cost prediction models benefit all stakeholders: helping patients avoid unexpected expenses, enabling providers to plan care more effectively, allowing insurers to set appropriate premiums, and providing policymakers with data to design more effective healthcare policies.

# Exploratory Data Analysis

```{r load_data}
insurance <- read.csv("insurance.csv")
str(insurance)

insurance <- insurance %>% select(-SSN, -Name)

num_observations <- nrow(insurance)
num_variables <- ncol(insurance)
print(paste("Number of observations:", num_observations))
print(paste("Number of variables:", num_variables))

insurance$sex <- as.factor(insurance$sex)
insurance$smoker <- as.factor(insurance$smoker)
insurance$region <- as.factor(insurance$region)
insurance$children <- as.factor(insurance$children)

sex_percentages <- prop.table(table(insurance$sex)) * 100
children_percentages <- prop.table(table(insurance$children)) * 100
smoker_percentages <- prop.table(table(insurance$smoker)) * 100
region_percentages <- prop.table(table(insurance$region)) * 100

print("Sex percentages:")
print(sex_percentages)
print("Children percentages:")
print(children_percentages)
print("Smoker percentages:")
print(smoker_percentages)
print("Region percentages:")
print(region_percentages)

age_mean <- mean(insurance$age)
age_sd <- sd(insurance$age)
bmi_mean <- mean(insurance$bmi)
bmi_sd <- sd(insurance$bmi)
charges_mean <- mean(insurance$charges)
charges_sd <- sd(insurance$charges)

print(paste("Age: Mean =", round(age_mean, 2), ", SD =", round(age_sd, 2)))
print(paste("BMI: Mean =", round(bmi_mean, 2), ", SD =", round(bmi_sd, 2)))
print(paste("Charges: Mean =", round(charges_mean, 2), ", SD =", round(charges_sd, 2)))
```

After looking at the data, I found there are 1338 observations and 7 variables once I removed the identifiers. Males make up about 50.52% of the dataset. Most people (43.42%) don't have any children. Most people aren't smokers (79.52%), which was kind of surprising to me. The southeast region has the most people at 27.28%. The average age is around 39 years old with a standard deviation of 14.05, and the BMI average is 30.66 (SD=6.10). The mean for medical charges is $13,270.42 but with a really big standard deviation ($12,110.01) showing charges vary a lot between people.
# Data Visualization

```{r data_visualization}
# Sex vs Charges
p1 <- ggplot(insurance, aes(x = sex, y = charges, fill = sex)) +
  geom_boxplot() +
  labs(title = "Figure 1: Medical Costs by Gender",
       x = "Gender", y = "Medical Costs (USD)") +
  theme_minimal()
print(p1)

# Children vs Charges
p2 <- ggplot(insurance, aes(x = children, y = charges, fill = children)) +
  geom_boxplot() +
  labs(title = "Figure 2: Medical Costs by Number of Dependents",
       x = "Number of Dependents", y = "Medical Costs (USD)") +
  theme_minimal()
print(p2)

# Smoker vs Charges
p3 <- ggplot(insurance, aes(x = smoker, y = charges, fill = smoker)) +
  geom_boxplot() +
  labs(title = "Figure 3: Medical Costs by Smoking Status",
       x = "Smoker", y = "Medical Costs (USD)") +
  theme_minimal()
print(p3)

# Region vs Charges
p4 <- ggplot(insurance, aes(x = region, y = charges, fill = region)) +
  geom_boxplot() +
  labs(title = "Figure 4: Medical Costs by Region",
       x = "Region", y = "Medical Costs (USD)") +
  theme_minimal()
print(p4)

# Age vs Charges
p5 <- ggplot(insurance, aes(x = age, y = charges)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "Figure 5: Age vs Medical Costs",
       x = "Age (years)", y = "Medical Costs (USD)") +
  theme_minimal()
print(p5)

# BMI vs Charges
p6 <- ggplot(insurance, aes(x = bmi, y = charges)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue") +
  labs(title = "Figure 6: BMI vs Medical Costs",
       x = "Body Mass Index (kg/mÂ²)", y = "Medical Costs (USD)") +
  theme_minimal()
print(p6)
```

when you obsereve figure 1 we can see that similar median costs between males and females, with males showing slightly higher variability.

from figure 2 we can see that median costs increase slightly with more dependents, with families having 4-5 children showing higher variability.

looking at figure 3 we can witness a dramatic difference in costs between smokers (median ~$32,000) and non-smokers (median ~$8,000), indicating smoking is a major cost factor.

when we look at figure 4 it indicates region has minimal impact on costs, with similar medians across regions.

Figure 5 demonstrates a positive linear relationship between age and costs, with costs increasing as age increases.

observing figure 6 we can see higher BMI values correlate with higher costs, with notable high-cost outliers for BMIs between 30-40.

# Multiple Linear Regression

```{r regression_model}
set.seed(123)

train_index <- createDataPartition(insurance$charges, p = 0.75, list = FALSE)
train_data <- insurance[train_index, ]
test_data <- insurance[-train_index, ]

model <- train(
  charges ~ age + sex + bmi + children + smoker + region,
  data = train_data,
  method = "lm"
)

print(model)
summary(model$finalModel)

predictions <- predict(model, newdata = test_data)
rmse <- sqrt(mean((predictions - test_data$charges)^2))
r_squared <- cor(predictions, test_data$charges)^2

print(paste("RMSE:", round(rmse, 2)))
print(paste("R-squared:", round(r_squared, 4)))

results <- data.frame(
  Actual = test_data$charges,
  Predicted = predictions
)
head(results)
```

noting the multiple linear regression model R-squared is approximately 0.75, i.e., 75% of the variability of medical expenses are accounted for by the predictors.
we can say Smoking status is the most powerful predictor, with smokers paying approximately $23,000 more in medical costs than non-smokers surprisingly. Age also plays a part, with an additional year of age costing approximately $256. BMI makes a significant contribution with each unit associated with approximately $325 more in costs. Number of dependents significantly affects but less so than smoking, BMI, or age. Region does have some cost variation but is less predictive than the other variables. The fit of test data is good with R-squared at approximately 0.77, indicating strong predictive capability.